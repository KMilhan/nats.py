<!DOCTYPE html>
<html >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>nats.aio.client</title>
    
          <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/theme.css " type="text/css" />
      
      <!-- sphinx script_files -->
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="../../../_static/theme-vendors.js"></script> -->
      <script src="../../../_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="../../../genindex.html" />
  <link rel="search" title="Search" href="../../../search.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../../../index.html" class="home-link">
    
      <img class="logo" src="../../../_static/nats-icon-color.png" alt="logo"/>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



  
    <div class="nav-item">
      <a href="https://github.com/nats-io/nats.py"
        class="nav-link external">
          Github <outboundlink></outboundlink>
      </a>
    </div>
  
    <div class="nav-item">
      <a href="https://nats.io"
        class="nav-link external">
          NATS <outboundlink></outboundlink>
      </a>
    </div>
  

    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



  
    <div class="nav-item">
      <a href="https://github.com/nats-io/nats.py"
        class="nav-link external">
          Github <outboundlink></outboundlink>
      </a>
    </div>
  
    <div class="nav-item">
      <a href="https://nats.io"
        class="nav-link external">
          NATS <outboundlink></outboundlink>
      </a>
    </div>
  

            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="../../../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../../index.html#nats-py">Documentation</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../../releases.html" class="reference internal ">Releases</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../modules.html" class="reference internal ">Modules</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../guides.html" class="reference internal ">Guides</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
    
      <li><a href="../../index.html">Module code</a> &raquo;</li>
    
      <li><a href="../../nats.html">nats</a> &raquo;</li>
    
    <li>nats.aio.client</li>
  </ul>
  

  <ul class="page-nav">
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <h1>Source code for nats.aio.client</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2016-2021 The NATS Authors</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">import</span> <span class="nn">ipaddress</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">AsyncIterator</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">email.parser</span> <span class="kn">import</span> <span class="n">BytesParser</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="kn">from</span> <span class="nn">nats.errors</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">nats.aio.errors</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">nats.aio.nuid</span> <span class="kn">import</span> <span class="n">NUID</span>
<span class="kn">from</span> <span class="nn">nats.protocol.parser</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">nats.protocol</span> <span class="kn">import</span> <span class="n">command</span> <span class="k">as</span> <span class="n">prot_command</span>
<span class="kn">from</span> <span class="nn">nats.js</span> <span class="kn">import</span> <span class="n">JetStream</span><span class="p">,</span> <span class="n">JetStreamContext</span><span class="p">,</span> <span class="n">JetStreamManager</span>
<span class="kn">from</span> <span class="nn">nats.js.errors</span> <span class="kn">import</span> <span class="n">NotJSMessageError</span>
<span class="kn">from</span> <span class="nn">nats.js</span> <span class="kn">import</span> <span class="n">api</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;2.0.0a2&#39;</span>
<span class="n">__lang__</span> <span class="o">=</span> <span class="s1">&#39;python3&#39;</span>
<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">PROTOCOL</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">INFO_OP</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;INFO&#39;</span>
<span class="n">CONNECT_OP</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;CONNECT&#39;</span>
<span class="n">PING_OP</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;PING&#39;</span>
<span class="n">PONG_OP</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;PONG&#39;</span>
<span class="n">OK_OP</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;+OK&#39;</span>
<span class="n">ERR_OP</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;-ERR&#39;</span>
<span class="n">_CRLF_</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
<span class="n">_SPC_</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span>
<span class="n">_EMPTY_</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
<span class="n">EMPTY</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="n">PING_PROTO</span> <span class="o">=</span> <span class="n">PING_OP</span> <span class="o">+</span> <span class="n">_CRLF_</span>
<span class="n">PONG_PROTO</span> <span class="o">=</span> <span class="n">PONG_OP</span> <span class="o">+</span> <span class="n">_CRLF_</span>
<span class="n">INBOX_PREFIX</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;_INBOX.&#39;</span><span class="p">)</span>
<span class="n">INBOX_PREFIX_LEN</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">INBOX_PREFIX</span><span class="p">)</span> <span class="o">+</span> <span class="mi">22</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">DEFAULT_PENDING_SIZE</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="n">DEFAULT_BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">32768</span>
<span class="n">DEFAULT_RECONNECT_TIME_WAIT</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># in seconds</span>
<span class="n">DEFAULT_MAX_RECONNECT_ATTEMPTS</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">DEFAULT_PING_INTERVAL</span> <span class="o">=</span> <span class="mi">120</span>  <span class="c1"># in seconds</span>
<span class="n">DEFAULT_MAX_OUTSTANDING_PINGS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">DEFAULT_MAX_PAYLOAD_SIZE</span> <span class="o">=</span> <span class="mi">1048576</span>
<span class="n">DEFAULT_MAX_FLUSHER_QUEUE_SIZE</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">DEFAULT_CONNECT_TIMEOUT</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># in seconds</span>
<span class="n">DEFAULT_DRAIN_TIMEOUT</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># in seconds</span>
<span class="n">MAX_CONTROL_LINE_SIZE</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="c1"># Default Pending Limits of Subscriptions</span>
<span class="n">DEFAULT_SUB_PENDING_MSGS_LIMIT</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="n">DEFAULT_SUB_PENDING_BYTES_LIMIT</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>

<span class="n">NATS_HDR_LINE</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;NATS/1.0</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">NATS_HDR_LINE_SIZE</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">NATS_HDR_LINE</span><span class="p">)</span>
<span class="n">NO_RESPONDERS_STATUS</span> <span class="o">=</span> <span class="s2">&quot;503&quot;</span>
<span class="n">STATUS_MSG_LEN</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># e.g. 20x, 40x, 50x</span>
<span class="n">CTRL_LEN</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_CRLF_</span><span class="p">)</span>
<span class="n">STATUS_HDR</span> <span class="o">=</span> <span class="s2">&quot;Status&quot;</span>
<span class="n">DESC_HDR</span> <span class="o">=</span> <span class="s2">&quot;Description&quot;</span>


<div class="viewcode-block" id="Subscription"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Subscription">[docs]</a><span class="k">class</span> <span class="nc">Subscription</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A subscription represents interest in a particular subject.</span>

<span class="sd">    A subscription should not be constructed directly, rather</span>
<span class="sd">    `connection.subscribe()` should be used to get a subscription.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">conn</span><span class="p">:</span> <span class="s1">&#39;Client&#39;</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">queue</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">cb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="s1">&#39;Msg&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">future</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_msgs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">pending_msgs_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_SUB_PENDING_MSGS_LIMIT</span><span class="p">,</span>
        <span class="n">pending_bytes_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_SUB_PENDING_BYTES_LIMIT</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="n">conn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subject</span> <span class="o">=</span> <span class="n">subject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="n">queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_msgs</span> <span class="o">=</span> <span class="n">max_msgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_received</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cb</span> <span class="o">=</span> <span class="n">cb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_future</span> <span class="o">=</span> <span class="n">future</span>

        <span class="c1"># Per subscription message processor.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_msgs_limit</span> <span class="o">=</span> <span class="n">pending_msgs_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_bytes_limit</span> <span class="o">=</span> <span class="n">pending_bytes_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">pending_msgs_limit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_msgs_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message_iterator</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># For JetStream enabled subscriptions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jsi</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">messages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="s1">&#39;Msg&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves an async iterator for the messages from the subscription.</span>

<span class="sd">        This is only available if a callback isn&#39;t provided when creating a</span>
<span class="sd">        subscription.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_iterator</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NatsError</span><span class="p">(</span>
                <span class="s2">&quot;cannot iterate over messages with a non iteration subscription type&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_iterator</span>

<div class="viewcode-block" id="Subscription.next_msg"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Subscription.next_msg">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">next_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        next_msg can be used to retrieve the next message</span>
<span class="sd">        from a stream of messages using await syntax.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">_next_msg</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_next_msg</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">ErrTimeout</span></div>

    <span class="k">def</span> <span class="nf">_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_cb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the resources for the subscription to start processing messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cb</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb</span><span class="p">,</span> <span class="s2">&quot;func&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cb</span><span class="o">.</span><span class="n">func</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">NatsError</span><span class="p">(</span><span class="s2">&quot;nats: must use coroutine for subscriptions&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_msgs_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_msgs</span><span class="p">(</span><span class="n">error_cb</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="p">:</span>
            <span class="c1"># Used to handle the single response from a request.</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_message_iterator</span> <span class="o">=</span> <span class="n">_SubscriptionMessageIterator</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pending_queue</span>
            <span class="p">)</span>

<div class="viewcode-block" id="Subscription.drain"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Subscription.drain">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">drain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes interest in a subject, but will process remaining messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Announce server that no longer want to receive more</span>
            <span class="c1"># messages in this sub and just process the ones remaining.</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">_send_unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>

            <span class="c1"># Roundtrip to ensure that the server has sent all messages.</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_queue</span><span class="p">:</span>
                <span class="c1"># Wait until no more messages are left,</span>
                <span class="c1"># then cancel the subscription task.</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

            <span class="c1"># stop waiting for messages</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_processing</span><span class="p">()</span>

            <span class="c1"># Subscription is done and won&#39;t be receiving further</span>
            <span class="c1"># messages so can throw it away now.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">_remove_sub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># In case draining of a connection times out then</span>
            <span class="c1"># the sub per task will be canceled as well.</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="Subscription.unsubscribe"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Subscription.unsubscribe">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes interest in a subject, remaining messages will be discarded.</span>

<span class="sd">        If `limit` is greater than zero, interest is not immediately removed,</span>
<span class="sd">        rather, interest will be automatically removed after `limit` messages</span>
<span class="sd">        are received.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">is_closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrConnectionClosed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">is_draining</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrConnectionDraining</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_max_msgs</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_received</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_processing</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">_remove_sub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">is_reconnecting</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">_send_unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_stop_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops the subscription from processing new messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_msgs_task</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_msgs_task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_msgs_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_iterator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_message_iterator</span><span class="o">.</span><span class="n">_cancel</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_wait_for_msgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_cb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A coroutine to read and process messages if a callback is provided.</span>

<span class="sd">        Should be called as a task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pending_size</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Invoke depending of type of handler.</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cb</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="c1"># In case the coroutine handler gets cancelled</span>
                    <span class="c1"># then stop task loop and return.</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># All errors from calling a handler</span>
                    <span class="c1"># are async errors.</span>
                    <span class="k">if</span> <span class="n">error_cb</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">error_cb</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># indicate the message finished processing so drain can continue</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pending_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="k">break</span></div>


<span class="k">class</span> <span class="nc">_SubscriptionMessageIterator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="n">queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unsubscribed_future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unsubscribed_future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unsubscribed_future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__aiter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__anext__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">get_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
        <span class="n">finished</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">([</span><span class="n">get_task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unsubscribed_future</span><span class="p">],</span>
                                         <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">get_task</span> <span class="ow">in</span> <span class="n">finished</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">get_task</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unsubscribed_future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="n">get_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">raise</span> <span class="ne">StopAsyncIteration</span>


<div class="viewcode-block" id="Msg"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Msg">[docs]</a><span class="k">class</span> <span class="nc">Msg</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Msg represents a message delivered by NATS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;reply&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;sid&#39;</span><span class="p">,</span> <span class="s1">&#39;_client&#39;</span><span class="p">,</span> <span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="s1">&#39;_metadata&#39;</span>
    <span class="p">)</span>

    <span class="k">class</span> <span class="nc">Ack</span><span class="p">:</span>
        <span class="n">Ack</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;+ACK&quot;</span>
        <span class="n">Nak</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;-NAK&quot;</span>
        <span class="n">Progress</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;+WPI&quot;</span>
        <span class="n">Term</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;+TERM&quot;</span>

        <span class="c1"># Reply metadata...</span>
        <span class="n">Prefix0</span> <span class="o">=</span> <span class="s1">&#39;$JS&#39;</span>
        <span class="n">Prefix1</span> <span class="o">=</span> <span class="s1">&#39;ACK&#39;</span>
        <span class="n">Domain</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">AccHash</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">Stream</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">Consumer</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">NumDelivered</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">StreamSeq</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="n">ConsumerSeq</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">Timestamp</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="n">NumPending</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="c1"># Subject without domain:</span>
        <span class="c1"># $JS.ACK.&lt;stream&gt;.&lt;consumer&gt;.&lt;delivered&gt;.&lt;sseq&gt;.&lt;cseq&gt;.&lt;tm&gt;.&lt;pending&gt;</span>
        <span class="c1">#</span>
        <span class="n">V1TokenCount</span> <span class="o">=</span> <span class="mi">9</span>

        <span class="c1"># Subject with domain:</span>
        <span class="c1"># $JS.ACK.&lt;domain&gt;.&lt;account hash&gt;.&lt;stream&gt;.&lt;consumer&gt;.&lt;delivered&gt;.&lt;sseq&gt;.&lt;cseq&gt;.&lt;tm&gt;.&lt;pending&gt;.&lt;a token with a random value&gt;</span>
        <span class="c1">#</span>
        <span class="n">V2TokenCount</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">reply</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">sid</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="s1">&#39;Client&#39;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="n">subject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">sid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        header returns the headers from a message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span>

<div class="viewcode-block" id="Msg.respond"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Msg.respond">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">respond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        respond replies to the inbox of the message if there is one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NatsError</span><span class="p">(</span><span class="s1">&#39;no reply subject available&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NatsError</span><span class="p">(</span><span class="s1">&#39;client not set&#39;</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span></div>

<div class="viewcode-block" id="Msg.ack"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Msg.ack">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">ack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ack acknowledges a message delivered by JetStream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotJSMessageError</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reply</span><span class="p">)</span></div>

<div class="viewcode-block" id="Msg.ack_sync"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Msg.ack_sync">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">ack_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ack_sync waits for the acknowledgement to be processed by the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotJSMessageError</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span></div>

<div class="viewcode-block" id="Msg.nak"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Msg.nak">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">nak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ack negatively acknowledges a message delivered by JetStream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotJSMessageError</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">Msg</span><span class="o">.</span><span class="n">Ack</span><span class="o">.</span><span class="n">Nak</span><span class="p">)</span></div>

<div class="viewcode-block" id="Msg.in_progress"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Msg.in_progress">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">in_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ack acknowledges a message delivered by JetStream is still being worked on.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotJSMessageError</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">Msg</span><span class="o">.</span><span class="n">Ack</span><span class="o">.</span><span class="n">Progress</span><span class="p">)</span></div>

<div class="viewcode-block" id="Msg.term"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Msg.term">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">term</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ack terminates a message delivered by JetStream and disables redeliveries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reply</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotJSMessageError</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">Msg</span><span class="o">.</span><span class="n">Ack</span><span class="o">.</span><span class="n">Term</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c1"># Memoize the parsed metadata.</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">_metadata</span>
        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">metadata</span>

        <span class="c1"># TODO: Support V2TokenCount style with domains.</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">Msg</span><span class="o">.</span><span class="n">Metadata</span><span class="o">.</span><span class="n">_get_metadata_fields</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">reply</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1_000_000_000.0</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">Msg</span><span class="o">.</span><span class="n">Metadata</span><span class="p">(</span>
            <span class="n">sequence</span><span class="o">=</span><span class="n">Msg</span><span class="o">.</span><span class="n">Metadata</span><span class="o">.</span><span class="n">SequencePair</span><span class="p">(</span>
                <span class="n">stream</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="n">consumer</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="p">),</span>
            <span class="n">num_delivered</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
            <span class="n">num_pending</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">8</span><span class="p">]),</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
            <span class="n">stream</span><span class="o">=</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">consumer</span><span class="o">=</span><span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="k">return</span> <span class="n">metadata</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: subject=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="si">}</span><span class="s2">&#39; reply=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reply</span><span class="si">}</span><span class="s2">&#39; data=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">...&#39;&gt;&quot;</span>

<div class="viewcode-block" id="Msg.Metadata"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Msg.Metadata">[docs]</a>    <span class="k">class</span> <span class="nc">Metadata</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Metadata is the metadata from a JetStream message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;num_delivered&#39;</span><span class="p">,</span> <span class="s1">&#39;num_pending&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;stream&#39;</span><span class="p">,</span> <span class="s1">&#39;consumer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sequence&#39;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Msg.Metadata.SequencePair"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Msg.Metadata.SequencePair">[docs]</a>        <span class="nd">@dataclass</span>
        <span class="k">class</span> <span class="nc">SequencePair</span><span class="p">:</span>
            <span class="n">consumer</span><span class="p">:</span> <span class="nb">int</span>
            <span class="n">stream</span><span class="p">:</span> <span class="nb">int</span></div>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">sequence</span><span class="p">:</span> <span class="s1">&#39;SequencePair&#39;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">num_pending</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">num_delivered</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">stream</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">consumer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_pending</span> <span class="o">=</span> <span class="n">num_pending</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_delivered</span> <span class="o">=</span> <span class="n">num_delivered</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span> <span class="o">=</span> <span class="n">consumer</span>

        <span class="k">def</span> <span class="nf">_get_metadata_fields</span><span class="p">(</span><span class="n">reply</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">reply</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">reply</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NotJSMessageError</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">reply</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Msg</span><span class="o">.</span><span class="n">Ack</span><span class="o">.</span><span class="n">V1TokenCount</span> <span class="ow">or</span> \
                   <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Msg</span><span class="o">.</span><span class="n">Ack</span><span class="o">.</span><span class="n">Prefix0</span> <span class="ow">or</span> \
                   <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Msg</span><span class="o">.</span><span class="n">Ack</span><span class="o">.</span><span class="n">Prefix1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NotJSMessageError</span>
            <span class="k">return</span> <span class="n">tokens</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: stream=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="si">}</span><span class="s2">&#39; consumer=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="si">}</span><span class="s2">&#39; sequence=(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">stream</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">consumer</span><span class="si">}</span><span class="s2">) timestamp=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">&gt;&quot;</span></div></div>


<div class="viewcode-block" id="Srv"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Srv">[docs]</a><span class="k">class</span> <span class="nc">Srv</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Srv is a helper data structure to hold state of a server.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reconnects</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_attempt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">did_connect</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discovered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tls_name</span> <span class="o">=</span> <span class="kc">None</span></div>


<span class="k">async</span> <span class="k">def</span> <span class="nf">_default_error_callback</span><span class="p">(</span><span class="n">ex</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides a default way to handle async errors if the user</span>
<span class="sd">    does not provide one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;nats: encountered error&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">ex</span><span class="p">)</span>


<div class="viewcode-block" id="Client"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Client">[docs]</a><span class="k">class</span> <span class="nc">Client</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asyncio based client for NATS.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">msg_class</span> <span class="o">=</span> <span class="n">Msg</span>

    <span class="c1"># FIXME: Use an enum instead.</span>
    <span class="n">DISCONNECTED</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">CONNECTED</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">CLOSED</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">RECONNECTING</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">CONNECTING</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">DRAINING_SUBS</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">DRAINING_PUBS</span> <span class="o">=</span> <span class="mi">6</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;nats client v</span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_pool</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reading_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ping_interval_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pings_outstanding</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pongs_received</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pongs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bare_io_reader</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_reader</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bare_io_writer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disconnected_cb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closed_cb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_discovered_server_cb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reconnected_cb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task_future</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_payload</span> <span class="o">=</span> <span class="n">DEFAULT_MAX_PAYLOAD_SIZE</span>
        <span class="c1"># This is the client id that the NATS server knows</span>
        <span class="c1"># about. Useful in debugging application errors</span>
        <span class="c1"># when logged with this identifier along</span>
        <span class="c1"># with nats server log.</span>
        <span class="c1"># This would make more sense if we log the server</span>
        <span class="c1"># connected to as well in case of cluster setup.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">DISCONNECTED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ps</span> <span class="o">=</span> <span class="n">Parser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flush_queue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flusher_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hdr_parser</span> <span class="o">=</span> <span class="n">BytesParser</span><span class="p">()</span>

        <span class="c1"># New style request/response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resp_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resp_sub_prefix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nuid</span> <span class="o">=</span> <span class="n">NUID</span><span class="p">()</span>

        <span class="c1"># NKEYS support</span>
        <span class="c1">#</span>
        <span class="c1"># user_jwt_cb is used to fetch and return the account</span>
        <span class="c1"># signed JWT for this user.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_jwt_cb</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># signature_cb is used to sign a nonce from the server while</span>
        <span class="c1"># authenticating with nkeys. The user should sign the nonce and</span>
        <span class="c1"># return the base64 encoded signature.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signature_cb</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># user credentials file can be a tuple or single file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_credentials</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># file that contains the nkeys seed and its public key as a string.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nkeys_seed</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_public_nkey</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;in_msgs&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;out_msgs&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;in_bytes&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;out_bytes&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;reconnects&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;errors_received&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">servers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nats://127.0.0.1:4222&quot;</span><span class="p">],</span>
        <span class="n">error_cb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="ne">Exception</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">disconnected_cb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">closed_cb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">discovered_server_cb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reconnected_cb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pedantic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">allow_reconnect</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">connect_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_CONNECT_TIMEOUT</span><span class="p">,</span>
        <span class="n">reconnect_time_wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_RECONNECT_TIME_WAIT</span><span class="p">,</span>
        <span class="n">max_reconnect_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_MAX_RECONNECT_ATTEMPTS</span><span class="p">,</span>
        <span class="n">ping_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_PING_INTERVAL</span><span class="p">,</span>
        <span class="n">max_outstanding_pings</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_MAX_OUTSTANDING_PINGS</span><span class="p">,</span>
        <span class="n">dont_randomize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">flusher_queue_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_MAX_FLUSHER_QUEUE_SIZE</span><span class="p">,</span>
        <span class="n">no_echo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">tls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tls_hostname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">drain_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_DRAIN_TIMEOUT</span><span class="p">,</span>
        <span class="n">signature_cb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">user_jwt_cb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user_credentials</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nkeys_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="p">[</span><span class="n">error_cb</span><span class="p">,</span> <span class="n">disconnected_cb</span><span class="p">,</span> <span class="n">closed_cb</span><span class="p">,</span> <span class="n">reconnected_cb</span><span class="p">,</span>
                   <span class="n">discovered_server_cb</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">cb</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">cb</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ErrInvalidCallbackType</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_server_pool</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span> <span class="o">=</span> <span class="n">error_cb</span> <span class="ow">or</span> <span class="n">_default_error_callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closed_cb</span> <span class="o">=</span> <span class="n">closed_cb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_discovered_server_cb</span> <span class="o">=</span> <span class="n">discovered_server_cb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reconnected_cb</span> <span class="o">=</span> <span class="n">reconnected_cb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disconnected_cb</span> <span class="o">=</span> <span class="n">disconnected_cb</span>

        <span class="c1"># NKEYS support</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signature_cb</span> <span class="o">=</span> <span class="n">signature_cb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_jwt_cb</span> <span class="o">=</span> <span class="n">user_jwt_cb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_credentials</span> <span class="o">=</span> <span class="n">user_credentials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nkeys_seed</span> <span class="o">=</span> <span class="n">nkeys_seed</span>

        <span class="c1"># Customizable options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;pedantic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pedantic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;allow_reconnect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allow_reconnect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;dont_randomize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dont_randomize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;reconnect_time_wait&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reconnect_time_wait</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;max_reconnect_attempts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_reconnect_attempts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ping_interval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ping_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;max_outstanding_pings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_outstanding_pings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;no_echo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_echo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;connect_timeout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">connect_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;drain_timeout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drain_timeout</span>

        <span class="k">if</span> <span class="n">tls</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;tls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tls</span>
        <span class="k">if</span> <span class="n">tls_hostname</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;tls_hostname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tls_hostname</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_credentials</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nkeys_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_nkeys_connect</span><span class="p">()</span>

        <span class="c1"># Queue used to trigger flushes to the socket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flush_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">flusher_queue_size</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;dont_randomize&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_server_pool</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_next_server</span><span class="p">()</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_connect_init</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">reconnects</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">ErrNoServers</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;max_reconnect_attempts&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Never stop reconnecting</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">NatsError</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                <span class="c1"># Bail on first attempt if reconnecting is disallowed.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;allow_reconnect&quot;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="n">e</span>

                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">DISCONNECTED</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">last_attempt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">reconnects</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_setup_nkeys_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_credentials</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_nkeys_jwt_connect</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_nkeys_seed_connect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_nkeys_jwt_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">nkeys</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="n">creds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_credentials</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">creds</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">creds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">user_cb</span><span class="p">():</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">creds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">contents</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span><span class="o">.</span><span class="n">st_size</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">contents</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_user_jwt_cb</span> <span class="o">=</span> <span class="n">user_cb</span>

            <span class="k">def</span> <span class="nf">sig_cb</span><span class="p">(</span><span class="n">nonce</span><span class="p">):</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">creds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">seed</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span><span class="o">.</span><span class="n">st_size</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
                <span class="n">kp</span> <span class="o">=</span> <span class="n">nkeys</span><span class="o">.</span><span class="n">from_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
                <span class="n">raw_signed</span> <span class="o">=</span> <span class="n">kp</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">nonce</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">raw_signed</span><span class="p">)</span>

                <span class="c1"># Best effort attempt to clear from memory.</span>
                <span class="n">kp</span><span class="o">.</span><span class="n">wipe</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">kp</span>
                <span class="k">del</span> <span class="n">seed</span>
                <span class="k">return</span> <span class="n">sig</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_signature_cb</span> <span class="o">=</span> <span class="n">sig_cb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Define the functions to be able to sign things using nkeys.</span>
            <span class="k">def</span> <span class="nf">user_cb</span><span class="p">():</span>
                <span class="n">user_jwt</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">creds</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
                        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;BEGIN NATS USER JWT&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">user_jwt</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
                            <span class="k">break</span>
                <span class="c1"># Remove trailing line break but reusing same memory view.</span>
                <span class="k">return</span> <span class="n">user_jwt</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">user_jwt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_user_jwt_cb</span> <span class="o">=</span> <span class="n">user_cb</span>

            <span class="k">def</span> <span class="nf">sig_cb</span><span class="p">(</span><span class="n">nonce</span><span class="p">):</span>
                <span class="n">user_seed</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">creds</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="c1"># Detect line where the NKEY would start and end,</span>
                        <span class="c1"># then seek and read into a fixed bytearray that</span>
                        <span class="c1"># can be wiped.</span>
                        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;BEGIN USER NKEY SEED&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">nkey_start_pos</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">ErrInvalidUserCredentials</span><span class="p">()</span>
                            <span class="n">nkey_end_pos</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                            <span class="n">nkey_size</span> <span class="o">=</span> <span class="n">nkey_end_pos</span> <span class="o">-</span> <span class="n">nkey_start_pos</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">nkey_start_pos</span><span class="p">)</span>

                            <span class="c1"># Only gather enough bytes for the user seed</span>
                            <span class="c1"># into the pre allocated bytearray.</span>
                            <span class="n">user_seed</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">nkey_size</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">user_seed</span><span class="p">)</span>
                <span class="n">kp</span> <span class="o">=</span> <span class="n">nkeys</span><span class="o">.</span><span class="n">from_seed</span><span class="p">(</span><span class="n">user_seed</span><span class="p">)</span>
                <span class="n">raw_signed</span> <span class="o">=</span> <span class="n">kp</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">nonce</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">raw_signed</span><span class="p">)</span>

                <span class="c1"># Delete all state related to the keys.</span>
                <span class="n">kp</span><span class="o">.</span><span class="n">wipe</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">user_seed</span>
                <span class="k">del</span> <span class="n">kp</span>
                <span class="k">return</span> <span class="n">sig</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_signature_cb</span> <span class="o">=</span> <span class="n">sig_cb</span>

    <span class="k">def</span> <span class="nf">_setup_nkeys_seed_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">nkeys</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">creds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nkeys_seed</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">creds</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span><span class="o">.</span><span class="n">st_size</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">kp</span> <span class="o">=</span> <span class="n">nkeys</span><span class="o">.</span><span class="n">from_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_public_nkey</span> <span class="o">=</span> <span class="n">kp</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">kp</span><span class="o">.</span><span class="n">wipe</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">kp</span>
        <span class="k">del</span> <span class="n">seed</span>

        <span class="k">def</span> <span class="nf">sig_cb</span><span class="p">(</span><span class="n">nonce</span><span class="p">):</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">creds</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span><span class="o">.</span><span class="n">st_size</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">kp</span> <span class="o">=</span> <span class="n">nkeys</span><span class="o">.</span><span class="n">from_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">raw_signed</span> <span class="o">=</span> <span class="n">kp</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">nonce</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">raw_signed</span><span class="p">)</span>

            <span class="c1"># Best effort attempt to clear from memory.</span>
            <span class="n">kp</span><span class="o">.</span><span class="n">wipe</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">kp</span>
            <span class="k">del</span> <span class="n">seed</span>
            <span class="k">return</span> <span class="n">sig</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_signature_cb</span> <span class="o">=</span> <span class="n">sig_cb</span>

<div class="viewcode-block" id="Client.close"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Client.close">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Closes the socket to which we are connected and</span>
<span class="sd">        sets the client to be in the CLOSED state.</span>
<span class="sd">        No further reconnections occur once reaching this point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">)</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">do_cbs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">status</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">CLOSED</span>

        <span class="c1"># Kick the flusher once again so it breaks</span>
        <span class="c1"># and avoid pending futures.</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_pending</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reading_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reading_task</span><span class="o">.</span><span class="n">cancelled</span><span class="p">(</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reading_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ping_interval_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ping_interval_task</span><span class="o">.</span><span class="n">cancelled</span><span class="p">(</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ping_interval_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flusher_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flusher_task</span><span class="o">.</span><span class="n">cancelled</span><span class="p">(</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flusher_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task</span><span class="o">.</span><span class="n">done</span><span class="p">(</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

            <span class="c1"># Wait for the reconection task to be done which should be soon.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task_future</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task_future</span><span class="o">.</span><span class="n">cancelled</span><span class="p">(</span>
                <span class="p">):</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task_future</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;reconnect_time_wait&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">):</span>
                <span class="k">pass</span>

        <span class="c1"># Relinquish control to allow background tasks to wrap up.</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># In case there is any pending data at this point, flush before disconnecting.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending</span><span class="p">[:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pending</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data_size</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>

        <span class="c1"># Cleanup subscriptions since not reconnecting so no need</span>
        <span class="c1"># to replay the subscriptions anymore.</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="c1"># FIXME: Should we clear the pending queue here?</span>
            <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">_wait_for_msgs_task</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sub</span><span class="o">.</span><span class="n">_wait_for_msgs_task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">_wait_for_msgs_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_cbs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disconnected_cb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disconnected_cb</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closed_cb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closed_cb</span><span class="p">()</span>

        <span class="c1"># Set the client_id back to None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client_id</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Client.drain"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Client.drain">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">drain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drain will put a connection into a drain state. All subscriptions will</span>
<span class="sd">        immediately be put into a drain state. Upon completion, the publishers</span>
<span class="sd">        will be drained and can not publish any additional messages. Upon draining</span>
<span class="sd">        of the publishers, the connection will be closed. Use the `closed_cb&#39;</span>
<span class="sd">        option to know when the connection has moved from draining to closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_draining</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrConnectionClosed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connecting</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_reconnecting</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrConnectionReconnecting</span>

        <span class="c1"># Start draining the subscriptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">DRAINING_SUBS</span>

        <span class="n">drain_tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">coro</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
            <span class="n">drain_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="n">drain_is_done</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">drain_tasks</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                <span class="n">drain_is_done</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;drain_timeout&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="n">drain_is_done</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span>
            <span class="n">drain_is_done</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span><span class="p">(</span><span class="n">ErrDrainTimeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">DRAINING_PUBS</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">)</span></div>

<div class="viewcode-block" id="Client.publish"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Client.publish">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">payload</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">reply</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a PUB command to the server on the specified subject.</span>
<span class="sd">        A reply can be used by the recipient to respond to the message.</span>

<span class="sd">          -&gt;&gt; PUB hello &lt;reply&gt; 5</span>
<span class="sd">          -&gt;&gt; MSG_PAYLOAD: world</span>
<span class="sd">          &lt;&lt;- MSG hello 2 5</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrConnectionClosed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_draining_pubs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrConnectionDraining</span>

        <span class="n">payload_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">payload_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_payload</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrMaxPayload</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_publish</span><span class="p">(</span>
            <span class="n">subject</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_size</span><span class="p">,</span> <span class="n">headers</span>
        <span class="p">)</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_publish</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_size</span><span class="p">,</span> <span class="n">headers</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends PUB command to the NATS server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">subject</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="c1"># Avoid sending messages with empty replies.</span>
            <span class="k">raise</span> <span class="n">ErrBadSubject</span>

        <span class="n">pub_cmd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pub_cmd</span> <span class="o">=</span> <span class="n">prot_command</span><span class="o">.</span><span class="n">pub_cmd</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">NATS_HDR_LINE</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">hdr</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="n">hdr</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
                <span class="n">hdr</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="n">hdr</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_CRLF_</span><span class="p">)</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_CRLF_</span><span class="p">)</span>
            <span class="n">pub_cmd</span> <span class="o">=</span> <span class="n">prot_command</span><span class="o">.</span><span class="n">hpub_cmd</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;out_msgs&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;out_bytes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">payload_size</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">pub_cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_pending</span><span class="p">()</span>

<div class="viewcode-block" id="Client.subscribe"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Client.subscribe">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">queue</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">cb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Msg</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">future</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_msgs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">pending_msgs_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_SUB_PENDING_MSGS_LIMIT</span><span class="p">,</span>
        <span class="n">pending_bytes_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_SUB_PENDING_BYTES_LIMIT</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Subscription</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expresses interest in a given subject.</span>

<span class="sd">        A `Subscription` object will be returned.</span>
<span class="sd">        If a callback is provided, messages will be processed asychronously.</span>
<span class="sd">        If a callback isn&#39;t provided, messages can be retrieved via an</span>
<span class="sd">        asynchronous iterator on the returned subscription object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subject</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrBadSubject</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrConnectionClosed</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_draining</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrConnectionDraining</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sid</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sid</span>

        <span class="n">sub</span> <span class="o">=</span> <span class="n">Subscription</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">sid</span><span class="p">,</span>
            <span class="n">subject</span><span class="p">,</span>
            <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
            <span class="n">cb</span><span class="o">=</span><span class="n">cb</span><span class="p">,</span>
            <span class="n">future</span><span class="o">=</span><span class="n">future</span><span class="p">,</span>
            <span class="n">max_msgs</span><span class="o">=</span><span class="n">max_msgs</span><span class="p">,</span>
            <span class="n">pending_msgs_limit</span><span class="o">=</span><span class="n">pending_msgs_limit</span><span class="p">,</span>
            <span class="n">pending_bytes_limit</span><span class="o">=</span><span class="n">pending_bytes_limit</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">sub</span><span class="o">.</span><span class="n">_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_subscribe</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sub</span></div>

    <span class="k">def</span> <span class="nf">_remove_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">max_msgs</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
        <span class="n">sub_cmd</span> <span class="o">=</span> <span class="n">prot_command</span><span class="o">.</span><span class="n">sub_cmd</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">_subject</span><span class="p">,</span> <span class="n">sub</span><span class="o">.</span><span class="n">_queue</span><span class="p">,</span> <span class="n">sub</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">sub_cmd</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_pending</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_init_request_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO just initialize it this way</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resp_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_resp_sub_prefix</span> <span class="o">=</span> <span class="n">INBOX_PREFIX</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resp_sub_prefix</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nuid</span><span class="o">.</span><span class="n">next</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resp_sub_prefix</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">resp_mux_subject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resp_sub_prefix</span><span class="p">[:]</span>
        <span class="n">resp_mux_subject</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span>
            <span class="n">resp_mux_subject</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">cb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_request_sub_callback</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_request_sub_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">subject</span><span class="p">[</span><span class="n">INBOX_PREFIX_LEN</span><span class="p">:]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resp_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fut</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">fut</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resp_map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">InvalidStateError</span><span class="p">):</span>
            <span class="c1"># Request may have timed out already so remove the entry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resp_map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="Client.request"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Client.request">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">payload</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">old_style</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Msg</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implements the request/response pattern via pub/sub</span>
<span class="sd">        using a single wildcard subscription that handles</span>
<span class="sd">        the responses.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">old_style</span><span class="p">:</span>
            <span class="c1"># FIXME: Support headers in old style requests.</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_old_style</span><span class="p">(</span>
                <span class="n">subject</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_new_style</span><span class="p">(</span>
                <span class="n">subject</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">headers</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">STATUS_HDR</span><span class="p">)</span> <span class="o">==</span> <span class="n">NO_RESPONDERS_STATUS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoRespondersError</span>
        <span class="k">return</span> <span class="n">msg</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_request_new_style</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_draining_pubs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrConnectionDraining</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resp_sub_prefix</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_request_sub</span><span class="p">()</span>

        <span class="c1"># Use a new NUID for the token inbox and then use the future.</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nuid</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">inbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resp_sub_prefix</span><span class="p">[:]</span>
        <span class="n">inbox</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resp_map</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">decode</span><span class="p">()]</span> <span class="o">=</span> <span class="n">future</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
            <span class="n">subject</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply</span><span class="o">=</span><span class="n">inbox</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
        <span class="p">)</span>

        <span class="c1"># Wait for the response or give up on timeout.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resp_map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
            <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">ErrTimeout</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_request_old_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implements the request/response pattern via pub/sub</span>
<span class="sd">        using an ephemeral subscription which will be published</span>
<span class="sd">        with a limited interest of 1 reply returning the response</span>
<span class="sd">        or raising a Timeout error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">next_inbox</span> <span class="o">=</span> <span class="n">INBOX_PREFIX</span><span class="p">[:]</span>
        <span class="n">next_inbox</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nuid</span><span class="o">.</span><span class="n">next</span><span class="p">())</span>
        <span class="n">inbox</span> <span class="o">=</span> <span class="n">next_inbox</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">inbox</span><span class="p">,</span> <span class="n">future</span><span class="o">=</span><span class="n">future</span><span class="p">,</span> <span class="n">max_msgs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sub</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply</span><span class="o">=</span><span class="n">inbox</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">sub</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">()</span>
            <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">ErrTimeout</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">unsub_cmd</span> <span class="o">=</span> <span class="n">prot_command</span><span class="o">.</span><span class="n">unsub_cmd</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">unsub_cmd</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_pending</span><span class="p">()</span>

<div class="viewcode-block" id="Client.flush"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Client.flush">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a ping to the server expecting a pong back ensuring</span>
<span class="sd">        what we have written so far has made it to the server and</span>
<span class="sd">        also enabling measuring of roundtrip time.</span>
<span class="sd">        In case a pong is not returned within the allowed timeout,</span>
<span class="sd">        then it will raise ErrTimeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrBadTimeout</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ErrConnectionClosed</span>

        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_ping</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">ErrTimeout</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connected_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">uri</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">servers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">servers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_pool</span><span class="p">:</span>
            <span class="n">servers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">srv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">servers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">discovered_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">servers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_pool</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">srv</span><span class="o">.</span><span class="n">discovered</span><span class="p">:</span>
                <span class="n">servers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">srv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">servers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the max payload which we received from the servers INFO</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_payload</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">client_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the client id which we received from the servers INFO</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the last error which may have occured.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pending_data_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data_size</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Client</span><span class="o">.</span><span class="n">CLOSED</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_reconnecting</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Client</span><span class="o">.</span><span class="n">RECONNECTING</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Client</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_draining</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_connecting</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Client</span><span class="o">.</span><span class="n">CONNECTING</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_draining</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Client</span><span class="o">.</span><span class="n">DRAINING_SUBS</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Client</span><span class="o">.</span><span class="n">DRAINING_PUBS</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_draining_pubs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Client</span><span class="o">.</span><span class="n">DRAINING_PUBS</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">priority</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pending</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data_size</span> <span class="o">&gt;</span> <span class="n">DEFAULT_PENDING_SIZE</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_pending</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_flush_pending</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># kick the flusher!</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_setup_server_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connect_url</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">connect_url</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;nats://&quot;</span> <span class="ow">in</span> <span class="n">connect_url</span> <span class="ow">or</span> <span class="s2">&quot;tls://&quot;</span> <span class="ow">in</span> <span class="n">connect_url</span><span class="p">:</span>
                    <span class="c1"># Closer to how the Go client handles this.</span>
                    <span class="c1"># e.g. nats://127.0.0.1:4222</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">connect_url</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">connect_url</span><span class="p">:</span>
                    <span class="c1"># Expand the scheme for the user</span>
                    <span class="c1"># e.g. 127.0.0.1:4222</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nats://</span><span class="si">{</span><span class="n">connect_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Just use the endpoint with the default NATS port.</span>
                    <span class="c1"># e.g. demo.nats.io</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nats://</span><span class="si">{</span><span class="n">connect_url</span><span class="si">}</span><span class="s2">:4222&quot;</span><span class="p">)</span>

                <span class="c1"># In case only endpoint with scheme was set.</span>
                <span class="c1"># e.g. nats://demo.nats.io or localhost:</span>
                <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nats://</span><span class="si">{</span><span class="n">uri</span><span class="o">.</span><span class="n">hostname</span><span class="si">}</span><span class="s2">:4222&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NatsError</span><span class="p">(</span><span class="s2">&quot;nats: invalid connect url option&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">hostname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">uri</span><span class="o">.</span><span class="n">hostname</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NatsError</span><span class="p">(</span><span class="s2">&quot;nats: invalid hostname in connect url&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server_pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Srv</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">connect_url</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">connect_url</span><span class="p">:</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_server_pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Srv</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NatsError</span><span class="p">(</span><span class="s2">&quot;nats: invalid connect url option&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NatsError</span><span class="p">(</span><span class="s2">&quot;nats: invalid connect url option&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_select_next_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Looks up in the server pool for an available server</span>
<span class="sd">        and attempts to connect.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_server_pool</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">raise</span> <span class="n">ErrNoServers</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_pool</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;max_reconnect_attempts&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">reconnects</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;max_reconnect_attempts&quot;</span><span class="p">]:</span>
                    <span class="c1"># Discard server since already tried to reconnect too many times</span>
                    <span class="k">continue</span>

            <span class="c1"># Not yet exceeded max_reconnect_attempts so can still use</span>
            <span class="c1"># this server in the future.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server_pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">last_attempt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">last_attempt</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span>
                    <span class="s2">&quot;reconnect_time_wait&quot;</span><span class="p">]:</span>
                <span class="c1"># Backoff connecting to server if we attempted recently.</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;reconnect_time_wait&quot;</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">last_attempt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                <span class="n">connection_future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">open_connection</span><span class="p">(</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">DEFAULT_BUFFER_SIZE</span>
                <span class="p">)</span>
                <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                    <span class="n">connection_future</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;connect_timeout&#39;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span> <span class="o">=</span> <span class="n">s</span>

                <span class="c1"># We keep a reference to the initial transport we used when</span>
                <span class="c1"># establishing the connection in case we later upgrade to TLS</span>
                <span class="c1"># after getting the first INFO message. This is in order to</span>
                <span class="c1"># prevent the GC closing the socket after we send CONNECT</span>
                <span class="c1"># and replace the transport.</span>
                <span class="c1">#</span>
                <span class="c1"># See https://github.com/nats-io/asyncio-nats/issues/43</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bare_io_reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_reader</span> <span class="o">=</span> <span class="n">r</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bare_io_writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span> <span class="o">=</span> <span class="n">w</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">last_attempt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                <span class="n">s</span><span class="o">.</span><span class="n">reconnects</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">continue</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_process_err</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes the raw error message sent by the server</span>
<span class="sd">        and close connection with current server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">STALE_CONNECTION</span> <span class="ow">in</span> <span class="n">err_msg</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_op_err</span><span class="p">(</span><span class="n">ErrStaleConnection</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">AUTHORIZATION_VIOLATION</span> <span class="ow">in</span> <span class="n">err_msg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="n">ErrAuthorization</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prot_err</span> <span class="o">=</span> <span class="n">err_msg</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;nats: </span><span class="si">{</span><span class="n">prot_err</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">NatsError</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="n">err</span>

            <span class="k">if</span> <span class="n">PERMISSIONS_ERR</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">do_cbs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connecting</span><span class="p">:</span>
            <span class="n">do_cbs</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># FIXME: Some errors such as &#39;Invalid Subscription&#39;</span>
        <span class="c1"># do not cause the server to close the connection.</span>
        <span class="c1"># For now we handle similar as other clients and close.</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">,</span> <span class="n">do_cbs</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_process_op_err</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process errors which occured while reading or parsing</span>
<span class="sd">        the protocol. If allow_reconnect is enabled it will</span>
<span class="sd">        try to switch the server to which it is currently connected</span>
<span class="sd">        otherwise it will disconnect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connecting</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_reconnecting</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;allow_reconnect&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">RECONNECTING</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ps</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task</span><span class="o">.</span><span class="n">cancelled</span><span class="p">(</span>
            <span class="p">):</span>
                <span class="c1"># Cancel the previous task in case it may still be running.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attempt_reconnect</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_disconnect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="n">e</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_attempt_reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reading_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reading_task</span><span class="o">.</span><span class="n">cancelled</span><span class="p">(</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reading_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ping_interval_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ping_interval_task</span><span class="o">.</span><span class="n">cancelled</span><span class="p">(</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ping_interval_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flusher_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flusher_task</span><span class="o">.</span><span class="n">cancelled</span><span class="p">(</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flusher_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disconnected_cb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disconnected_cb</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;dont_randomize&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span>
                <span class="s2">&quot;dont_randomize&quot;</span><span class="p">]:</span>
            <span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_server_pool</span><span class="p">)</span>

        <span class="c1"># Create a future that the client can use to control waiting</span>
        <span class="c1"># on the reconnection attempts.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task_future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Try to establish a TCP connection to a server in</span>
                <span class="c1"># the cluster then send CONNECT command to it.</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_next_server</span><span class="p">()</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_connect_init</span><span class="p">()</span>

                <span class="c1"># Consider a reconnect to be done once CONNECT was</span>
                <span class="c1"># processed by the server successfully.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;reconnects&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Reset reconnect attempts for this server</span>
                <span class="c1"># since have successfully connected.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">did_connect</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">reconnects</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Replay all the subscriptions in case there were some.</span>
                <span class="n">subs_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">sub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">max_msgs</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">_max_msgs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># If we already hit the message limit, remove the subscription and don&#39;t resubscribe</span>
                        <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">_received</span> <span class="o">&gt;=</span> <span class="n">sub</span><span class="o">.</span><span class="n">_max_msgs</span><span class="p">:</span>
                            <span class="n">subs_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="c1"># auto unsubscribe the number of messages we have left</span>
                        <span class="n">max_msgs</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">_max_msgs</span> <span class="o">-</span> <span class="n">sub</span><span class="o">.</span><span class="n">_received</span>

                    <span class="n">sub_cmd</span> <span class="o">=</span> <span class="n">prot_command</span><span class="o">.</span><span class="n">sub_cmd</span><span class="p">(</span>
                        <span class="n">sub</span><span class="o">.</span><span class="n">_subject</span><span class="p">,</span> <span class="n">sub</span><span class="o">.</span><span class="n">_queue</span><span class="p">,</span> <span class="n">sid</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sub_cmd</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">max_msgs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">unsub_cmd</span> <span class="o">=</span> <span class="n">prot_command</span><span class="o">.</span><span class="n">unsub_cmd</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">max_msgs</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">unsub_cmd</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">subs_to_remove</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>

                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>

                <span class="c1"># Flush pending data before continuing in connected status.</span>
                <span class="c1"># FIXME: Could use future here and wait for an error result</span>
                <span class="c1"># to bail earlier in case there are errors in the connection.</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_pending</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">CONNECTED</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconnected_cb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconnected_cb</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task_future</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">ErrNoServers</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">NatsError</span><span class="p">,</span> <span class="n">ErrTimeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_err</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">RECONNECTING</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">last_attempt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">reconnects</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task_future</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task_future</span><span class="o">.</span><span class="n">cancelled</span><span class="p">(</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reconnection_task_future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_connect_command</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Generates a JSON string with the params to be used</span>
<span class="sd">        when sending CONNECT to the server.</span>

<span class="sd">          -&gt;&gt; CONNECT {&quot;lang&quot;: &quot;python3&quot;}</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">],</span>
            <span class="s2">&quot;pedantic&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;pedantic&quot;</span><span class="p">],</span>
            <span class="s2">&quot;lang&quot;</span><span class="p">:</span> <span class="n">__lang__</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">__version__</span><span class="p">,</span>
            <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="n">PROTOCOL</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;headers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;no_responders&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;auth_required&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span><span class="p">[</span><span class="s2">&quot;auth_required&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s2">&quot;nonce&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signature_cb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signature_cb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span><span class="p">[</span><span class="s2">&quot;nonce&quot;</span><span class="p">])</span>
                    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_jwt_cb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">jwt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_jwt_cb</span><span class="p">()</span>
                        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;jwt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_nkey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;nkey&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_nkey</span>
                <span class="c1"># In case there is no password, then consider handle</span>
                <span class="c1"># sending a token instead.</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span>
                        <span class="s2">&quot;password&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
                    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;pass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">options</span><span class="p">[</span><span class="s2">&quot;auth_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">username</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">password</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;auth_token&quot;</span>
                                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">username</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">username</span>
                        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;pass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">password</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;no_echo&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;echo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;no_echo&quot;</span><span class="p">]</span>

        <span class="n">connect_opts</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">CONNECT_OP</span> <span class="o">+</span> <span class="n">_SPC_</span> <span class="o">+</span> <span class="n">connect_opts</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="n">_CRLF_</span><span class="p">])</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_process_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process PING sent by server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">PONG</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_pending</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_process_pong</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process PONG sent by server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pongs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pongs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pongs_received</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pings_outstanding</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_process_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process MSG sent by server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">payload_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;in_msgs&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;in_bytes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">payload_size</span>

        <span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sub</span><span class="p">:</span>
            <span class="c1"># Skip in case no subscription present.</span>
            <span class="k">return</span>

        <span class="n">sub</span><span class="o">.</span><span class="n">_received</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">_max_msgs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sub</span><span class="o">.</span><span class="n">_received</span> <span class="o">&gt;=</span> <span class="n">sub</span><span class="o">.</span><span class="n">_max_msgs</span><span class="p">:</span>
            <span class="c1"># Enough messages so can throwaway subscription now.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">_stop_processing</span><span class="p">()</span>

        <span class="n">hdr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Check the rest of the headers in case there is any.</span>
            <span class="n">raw_headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">NATS_HDR_LINE</span><span class="p">):]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parsed_hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdr_parser</span><span class="o">.</span><span class="n">parsebytes</span><span class="p">(</span><span class="n">raw_headers</span><span class="p">)</span>
                <span class="c1"># Check if it is an inline status message like:</span>
                <span class="c1">#</span>
                <span class="c1"># NATS/1.0 404 No Messages</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsed_hdr</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">NATS_HDR_LINE</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">l</span><span class="p">[:</span><span class="n">STATUS_MSG_LEN</span><span class="p">]</span>
                    <span class="n">desc</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">STATUS_MSG_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="n">CTRL_LEN</span> <span class="o">-</span> <span class="n">CTRL_LEN</span><span class="p">]</span>
                    <span class="n">hdr</span><span class="p">[</span><span class="n">STATUS_HDR</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">hdr</span><span class="p">[</span><span class="n">DESC_HDR</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parsed_hdr</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">hdr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_message</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">hdr</span><span class="p">)</span>

        <span class="c1"># Check if it is an old style request.</span>
        <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">_future</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">_future</span><span class="o">.</span><span class="n">cancelled</span><span class="p">():</span>
                <span class="c1"># Already gave up, nothing to do.</span>
                <span class="k">return</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">_future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Let subscription wait_for_msgs coroutine process the messages,</span>
        <span class="c1"># but in case sending to the subscription task would block,</span>
        <span class="c1"># then consider it to be an slow consumer and drop the message.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">_pending_size</span> <span class="o">+=</span> <span class="n">payload_size</span>
            <span class="c1"># allow setting pending_bytes_limit to 0 to disable</span>
            <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">_pending_bytes_limit</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sub</span><span class="o">.</span><span class="n">_pending_size</span> <span class="o">&gt;=</span> <span class="n">sub</span><span class="o">.</span><span class="n">_pending_bytes_limit</span><span class="p">:</span>
                <span class="c1"># Subtract the bytes since the message will be thrown away</span>
                <span class="c1"># so it would not be pending data.</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">_pending_size</span> <span class="o">-=</span> <span class="n">payload_size</span>

                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span><span class="p">(</span>
                    <span class="n">SlowConsumerError</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">,</span> <span class="n">sub</span><span class="o">=</span><span class="n">sub</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">_pending_queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">QueueFull</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span><span class="p">(</span>
                <span class="n">SlowConsumerError</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">,</span> <span class="n">sub</span><span class="o">=</span><span class="n">sub</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_class</span><span class="p">(</span>
            <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
            <span class="n">reply</span><span class="o">=</span><span class="n">reply</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">client</span><span class="o">=</span><span class="bp">self</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process disconnection from the server and set client status</span>
<span class="sd">        to DISCONNECTED.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">DISCONNECTED</span>

    <span class="k">def</span> <span class="nf">_process_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">initial_connection</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process INFO lines sent by the server to reconfigure client</span>
<span class="sd">        with latest updates from cluster to enable server discovery.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;connect_urls&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;connect_urls&#39;</span><span class="p">]:</span>
                <span class="n">connect_urls</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">connect_url</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;connect_urls&#39;</span><span class="p">]:</span>
                    <span class="n">scheme</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;tls&#39;</span><span class="p">:</span>
                        <span class="n">scheme</span> <span class="o">=</span> <span class="s1">&#39;tls&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scheme</span> <span class="o">=</span> <span class="s1">&#39;nats&#39;</span>

                    <span class="n">uri</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scheme</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">connect_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">srv</span> <span class="o">=</span> <span class="n">Srv</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
                    <span class="n">srv</span><span class="o">.</span><span class="n">discovered</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># Check whether we should reuse the original hostname.</span>
                    <span class="k">if</span> <span class="s1">&#39;tls_required&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span><span class="p">[</span><span class="s1">&#39;tls_required&#39;</span><span class="p">]</span> \
                           <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host_is_ip</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">hostname</span><span class="p">):</span>
                        <span class="n">srv</span><span class="o">.</span><span class="n">tls_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">hostname</span>

                    <span class="c1"># Filter for any similar server in the server pool already.</span>
                    <span class="n">should_add</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_pool</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">netloc</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">netloc</span><span class="p">:</span>
                            <span class="n">should_add</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">should_add</span><span class="p">:</span>
                        <span class="n">connect_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">srv</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;dont_randomize&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">shuffle</span><span class="p">(</span><span class="n">connect_urls</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">connect_urls</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_server_pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">srv</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">initial_connection</span> <span class="ow">and</span> <span class="n">connect_urls</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discovered_server_cb</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_discovered_server_cb</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_host_is_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connect_url</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_address</span><span class="p">(</span><span class="n">connect_url</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_process_connect_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process INFO received from the server and CONNECT to the server</span>
<span class="sd">        with authentication.  It is also responsible of setting up the</span>
<span class="sd">        reading and ping interval tasks from the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">CONNECTING</span>

        <span class="n">connection_completed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">info_line</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
            <span class="n">connection_completed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;connect_timeout&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">INFO_OP</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info_line</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NatsError</span><span class="p">(</span>
                <span class="s2">&quot;nats: empty response from server when expecting INFO message&quot;</span>
            <span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">info_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">INFO_OP</span> <span class="o">+</span> <span class="n">_SPC_</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">srv_info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NatsError</span><span class="p">(</span><span class="s2">&quot;nats: info message, json parse error&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span> <span class="o">=</span> <span class="n">srv_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_info</span><span class="p">(</span><span class="n">srv_info</span><span class="p">,</span> <span class="n">initial_connection</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;max_payload&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span><span class="p">[</span><span class="s2">&quot;max_payload&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;client_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;tls_required&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_info</span><span class="p">[</span>
                <span class="s1">&#39;tls_required&#39;</span><span class="p">]:</span>
            <span class="n">ssl_context</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;tls&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
                <span class="n">ssl_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tls&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;tls&#39;</span><span class="p">:</span>
                <span class="n">ssl_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NatsError</span><span class="p">(</span><span class="s1">&#39;nats: no ssl context provided&#39;</span><span class="p">)</span>

            <span class="c1"># Check whether to reuse the original hostname for an implicit route.</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;tls_hostname&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
                <span class="n">hostname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;tls_hostname&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">tls_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hostname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">tls_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hostname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_server</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">hostname</span>

            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>  <span class="c1"># just in case something is left</span>

            <span class="c1"># loop.start_tls was introduced in python 3.7</span>
            <span class="c1"># the previous method is removed in 3.9</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
                <span class="c1"># manually recreate the stream reader/writer with a tls upgraded transport</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">StreamReader</span><span class="p">()</span>
                <span class="n">protocol</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">StreamReaderProtocol</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
                <span class="n">transport_future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">start_tls</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">transport</span><span class="p">,</span>
                    <span class="n">protocol</span><span class="p">,</span>
                    <span class="n">ssl_context</span><span class="p">,</span>
                    <span class="n">server_hostname</span><span class="o">=</span><span class="n">hostname</span>
                <span class="p">)</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                    <span class="n">transport_future</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;connect_timeout&#39;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">StreamWriter</span><span class="p">(</span>
                    <span class="n">transport</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_io_reader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span> <span class="o">=</span> <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">transport</span>
                <span class="n">sock</span> <span class="o">=</span> <span class="n">transport</span><span class="o">.</span><span class="n">get_extra_info</span><span class="p">(</span><span class="s1">&#39;socket&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sock</span><span class="p">:</span>
                    <span class="c1"># This shouldn&#39;t happen</span>
                    <span class="k">raise</span> <span class="n">NatsError</span><span class="p">(</span><span class="s1">&#39;nats: unable to get socket&#39;</span><span class="p">)</span>

                <span class="n">connection_future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">open_connection</span><span class="p">(</span>
                    <span class="n">limit</span><span class="o">=</span><span class="n">DEFAULT_BUFFER_SIZE</span><span class="p">,</span>
                    <span class="n">sock</span><span class="o">=</span><span class="n">sock</span><span class="p">,</span>
                    <span class="n">ssl</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
                    <span class="n">server_hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_io_reader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                    <span class="n">connection_future</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;connect_timeout&#39;</span><span class="p">]</span>
                <span class="p">)</span>

        <span class="c1"># Refresh state of parser upon reconnect.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_reconnecting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ps</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="n">connect_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect_command</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">connect_cmd</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]:</span>
            <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">next_op</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                <span class="n">future</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;connect_timeout&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">OK_OP</span> <span class="ow">in</span> <span class="n">next_op</span><span class="p">:</span>
                <span class="c1"># Do nothing</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">ERR_OP</span> <span class="ow">in</span> <span class="n">next_op</span><span class="p">:</span>
                <span class="n">err_line</span> <span class="o">=</span> <span class="n">next_op</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">err_msg</span> <span class="o">=</span> <span class="n">err_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># FIXME: Maybe handling could be more special here,</span>
                <span class="c1"># checking for ErrAuthorization for example.</span>
                <span class="c1"># await self._process_err(err_msg)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">err_line</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">NatsError</span><span class="p">(</span><span class="s2">&quot;nats: &quot;</span> <span class="o">+</span> <span class="n">err_msg</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">PING_PROTO</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>

        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">next_op</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
            <span class="n">future</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;connect_timeout&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">PONG_PROTO</span> <span class="ow">in</span> <span class="n">next_op</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">CONNECTED</span>
        <span class="k">elif</span> <span class="n">ERR_OP</span> <span class="ow">in</span> <span class="n">next_op</span><span class="p">:</span>
            <span class="n">err_line</span> <span class="o">=</span> <span class="n">next_op</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">err_msg</span> <span class="o">=</span> <span class="n">err_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># FIXME: Maybe handling could be more special here,</span>
            <span class="c1"># checking for ErrAuthorization for example.</span>
            <span class="c1"># await self._process_err(err_msg)</span>
            <span class="k">raise</span> <span class="n">NatsError</span><span class="p">(</span><span class="s2">&quot;nats: &quot;</span> <span class="o">+</span> <span class="n">err_msg</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">PONG_PROTO</span> <span class="ow">in</span> <span class="n">next_op</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Client</span><span class="o">.</span><span class="n">CONNECTED</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reading_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_loop</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pongs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pings_outstanding</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ping_interval_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ping_interval</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Task for kicking the flusher queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flusher_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flusher</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">future</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pongs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">PING_PROTO</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_pending</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_flusher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Coroutine which continuously tries to consume pending commands</span>
<span class="sd">        and then flushes them to the socket.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connecting</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending</span><span class="p">[:])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pending</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pending_data_size</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_op_err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># RuntimeError in case the event loop is closed</span>
                <span class="k">break</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ping_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ping_interval&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pings_outstanding</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pings_outstanding</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span>
                        <span class="s2">&quot;max_outstanding_pings&quot;</span><span class="p">]:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_op_err</span><span class="p">(</span><span class="n">ErrStaleConnection</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_ping</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="c1"># except asyncio.InvalidStateError:</span>
            <span class="c1">#     pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_read_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Coroutine which gathers bytes sent by the server</span>
<span class="sd">        and feeds them to the protocol parser.</span>
<span class="sd">        In case of error while reading, it will stop running</span>
<span class="sd">        and its task has to be rescheduled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">should_bail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_reconnecting</span>
                <span class="k">if</span> <span class="n">should_bail</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_reader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_reader</span><span class="o">.</span><span class="n">at_eof</span><span class="p">():</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_cb</span><span class="p">(</span><span class="n">ErrStaleConnection</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_op_err</span><span class="p">(</span><span class="n">ErrStaleConnection</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="n">b</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">DEFAULT_BUFFER_SIZE</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ps</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ProtocolError</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_op_err</span><span class="p">(</span><span class="n">ProtocolError</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_op_err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;nats: encountered error&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">ex</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="c1"># except asyncio.InvalidStateError:</span>
            <span class="c1">#     pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For when NATS client is used in a context manager&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close connection to NATS when used in a context manager&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">(</span><span class="n">Client</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">,</span> <span class="n">do_cbs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="Client.jetstream"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Client.jetstream">[docs]</a>    <span class="k">def</span> <span class="nf">jetstream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;JetStream context that can be used to interact with JetStream&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">JetStreamContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span></div>

<div class="viewcode-block" id="Client.jsm"><a class="viewcode-back" href="../../../modules.html#nats.aio.client.Client.jsm">[docs]</a>    <span class="k">def</span> <span class="nf">jsm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;JetStream context for managing JetStream via JS API&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">JetStreamManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2021, The NATS Authors.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>